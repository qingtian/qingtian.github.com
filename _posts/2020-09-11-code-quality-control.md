---
layout:     post
title:      "谈谈工程代码质量控制的事"
subtitle:   ""
date:       2020-09-11
author:     "qingtian"
catalog:    true
tags:
    - 代码质量
    - 单元测试
    - code review
    - 个人思考
---

# 1. 前言

从2011年开始工作，我工作至今也有9个多年头了。工作中或多或少总会看到各式各样的代码习惯，有些人关注模式与结构，有些人关注性能与实现，有些人关注“可运行”，还有一些人只是在“堆代码”实现需求罢了。

对于产品来说，工程代码质量是一个若隐若现的存在，好的时候感觉不到他的存在。而不好的时候，我们往往可以很明显的觉察到“不对劲”。

因此从保证产品价值层面来说，如何有效进行工程代码质量控制就非常值得我们深度思考一下了。下面我就来讲讲，我对工程代码质量控制的理解与实践经验，希望能给到大家一些借鉴意义。


# 2. 质量控制的3种方法

对于质量控制，我认为主要存在3种方法：

* 使用统一的开发规范来定义基础代码组织结构
* 补充各层的单元测试用例（数据层，业务层，控制层，UI层等）
* 多人协作时的相互代码review机制
 
以上3种方法，我把它们定义为质量控制中的三个核心环节：

* 事前
* 事中
* 事后

```
“事前”的规范制定与执行，
“事中”的代码单元测试编写，执行与代码覆盖，
“事后”的代码review机制。
```

从质量缺陷修复成本来看，我强烈建议大家加强更早环节的约束力。

```
3个方法强制性约束从强到弱可以排序为：规范 > 单元测试 >  代码review。
```

因此对于希望优化工程代码质量的你来说，需要从意识与行动不断实践质量控制的这3个方法。制定规范并严格执行，尽可能多进行单元测试，尽量频繁地相互进行代码review。当这些步骤得到切实落实后，一般来说会对整体工程代码质量有一个比较大的提升。

以上的经验主要是由我在云信，猛犸，EP的开发过程中总结得出。

## 2.1 开发规范的重要性

开发规范主要应用在前后端领域，由于多人协作本身不同人员的能力，经验，抽象层次深度差异，因此容易在无开发规范情况下，导致代码“失控”。代码质量岌岌可危，问题频出，严重影响了产品原有功能体验。因此定义一套简单，标准，有意义的规范势在必行，行业中不同公司往往都有自己的规范，我们也可以采用“拿来主义”，依靠别人的经验前行。

开发规范主要涉及以下几块内容：

* 开发工具
* 开发工具使用的插件
* 代码分支管理体系
* 持续集成体系
* 部署体系
 
针对不同的开发，规范所使用的工具，插件，持续集成有些许不同，不过整体来说大同小异。

下面我从前后端分别作一些简要介绍。

**前端**：

前端首推开发工具：VSCode。VSCode的功能完善，插件丰富，迭代快速，大家可以通过其官网进行软件下载([下载VSCode](https://code.visualstudio.com/download))。

VSCode我推荐安装的插件有：

* 文件图标 vscode-icons：（美化文件导航的ICON，提高识别效率 ）
* 暗色主题 One Dark Pro：（专注与防视力疲劳）
* 代码美化 Beautify：快速格式化代码，结构规整，方便共享与维护
* 代码检查工具 ESLint：语法规则和代码风格检查工具
* 快速注释 Document This：规范格式与标准化
* CSS 类名智能提示 IntelliSense for CSS class names in HTML：快速在HTML引用与提示已定义的CSS类名
* 代码拼写检查 Code Spell Checker：单词拼写检查

当然我们进行前端开发，也会使用一些第三方的服务来进行基础功能的支持，如埋点，性能监控等。对于埋点，我首推Google Analytics，谁用谁知道。对于性能监控方面，由于不同团队的差异比较大，这里就不展开讲了，大家可根据实际情况有针对性的选择即可。

对于前端CI流程，大家往往会想到Jekins。在公司内容，我们可以使用Overmind来实现（其底层也是基于Jekins实现），只是用起来更简洁，与其他功能集成度更高，推荐大家集成使用。 

代码开发规范主要是两块：代码风格与代码问题扫描。这里我推荐使用[EditorConfig for VS Code](https://marketplace.visualstudio.com/items?itemName=EditorConfig.EditorConfig) 和 [eslint](https://cn.eslint.org/)。具体配置可以查看官方描述进行，这里我就不赘述了。

**后端**：


## 2.2 单元测试的意义

单元测试，顾名思义，在局部控制代码符合预期，不断补充场景用例，不断执行以达到功能代码/逻辑分支的更高的覆盖度，让代码的变动影响“自己”说出来。

一般针对前端代码，我们需要保持一个好的习惯（开发设计思路）：每个工具函数必要有完整的用例覆盖保证质量，再由工具高质量的代码构建组件，模块，页面，再以更高维度的用例来保证每个大块的质量。以小见大，说的就是这个道理。

一般针对后端代码，我们在合理的设计模式与代码结构分层/构架基础上，需要额外考虑以下几个问题：

* 代码的可见性（访问控制合理性）
* 代码的内聚性
* 代码的扩展性
* 代码的可测试性（非常重要）
* 代码的分层体系以及每一层需要关注的重点测试点

通常来说，我们需要做到的测试覆盖范围有：

* 数据层全覆盖
* 业务层全覆盖
* 控制层全覆盖
* 工具类全覆盖
* UI层重点覆盖
* 核心流程接口全覆盖
 
```
“质量不是一蹴而就，每一个小步都为了更好的一大步。”
```

## 2.3 代码review机制探索

人员水平差异如此不可控，那如何来保证代码质量呢，最直接有效的莫过于代码review机制。让有经验的人/团队来review新人的代码，发现问题，解决问题，改进代码抽象与实现，一步步查漏补缺，构建软件“大厦”。

```
好的代码应该被看见，被借鉴，被影响。
```

代码review主要分为两种机制：

* 培养找臭虫/找亮点的意识
* 执行频繁点对点相互代码review
 
**机制1：寻找代码世界的糟粕与美好**

可以通过固定周期的会议来承载，时间大约在1小时左右。每个前后端同学都需要在会议前搜集现有工程或外部看到的开源项目中比较好的代码，然后针对代码进行重点分析与轮流讲解，内容需要包括：“代码示例”，“原因分析”，“改进方面意见”等。

这些会议承载的内容最终落地到团队wiki中，逐条记录代码规则，日积月累后再总结形成团队人员编写代码的执行规范。

**机制2：用知识改造代码**

这种机制主要关注于“**频繁**”，“**点对点**”的代码review与改造，具体操作方法可以采取每日下班/上班前的"例行公事"：

前面所写的BUG修复，功能开发涉及的提交发给相应同事，请求当面review
review同学备注/面对面沟通代码中可能存在的问题，提出改进意见
功能负责同学改进代码质量并再次发起review，以此往复
review结果进行系统性的汇总
